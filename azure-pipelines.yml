stages:
- stage: 'Build'
  displayName: 'Build Stage'
jobs: 
  - job: Build
    displayName: 'Build job'
    pool:
      vmImage: 'Ubuntu-16.04'
      demands:
        - npm

    steps:
    - task: DotNetCoreInstaller@0
      displayName: 'Use .NET Core SDK 2.1.505'
      inputs:
        version: 2.1.505

    - task: Npm@1
      displayName: 'Run npm install'
      inputs:
        verbose: false

    - script: './node_modules/.bin/node-sass Tailspin.SpaceGame.Web/wwwroot --output Tailspin.SpaceGame.Web/wwwroot'
      displayName: 'Compile Sass assets'

    - task: gulp@1
      displayName: 'Run gulp tasks'

    - script: 'echo "$(Build.DefinitionName), $(Build.BuildId), $(Build.BuildNumber)" > buildinfo.txt'
      displayName: 'Write build info'
      workingDirectory: Tailspin.SpaceGame.Web/wwwroot

    - task: DotNetCoreCLI@2
      displayName: 'Restore project dependencies'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'

    - task: DotNetCoreCLI@2
      displayName: 'Build the project - Release'
      inputs:
        command: 'build'
        arguments: '--no-restore --configuration Release'
        projects: '**/*.csproj'

    - task: DotNetCoreCLI@2
      displayName: 'Publish the project - Release'
      inputs:
        command: 'publish'
        projects: '**/*.csproj'
        publishWebProjects: false
        arguments: '--no-build --configuration Release --output $(Build.ArtifactStagingDirectory)/Release'
        zipAfterPublish: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      condition: succeeded()
# - stage: 'Deploy to an Azure AppService'
#   steps: 
# - task: AzureRmWebAppDeployment@4   
#   displayName: 'Deploy Azure App Service'
#   inputs:     
#     azureSubscription: '$(Parameters.ConnectedServiceName)'     
#     appType: '$(Parameters.WebAppKind)'    
#     WebAppName: '$(Parameters.WebAppName)'     
#     StartupCommand: '$(Parameters.StartupCommand)' 

  - stage: 'Deploy'
    displayName: 'Deploy Testing Stage'
    dependsOn: Build
    jobs:
      -job: DeployTest
      displayName: 'Deploy test job'
      conditionOnError: "true"
      pool:
        vmImage: 'Ubuntu-16.04'
      steps: 
      - task: DownloadBuildArtifact@0
        inputs:
          buildType: 'current'
          downloadType: 'single'
          artifactName: 'drop'
          downloadPath: '$(build.artifactstagingdirectory)'
      - task: AzureRmWebAppDeployment@4   
        displayName: 'Azure App Service Deploy: website'
        inputs:     
          azureSubscription: 'Visual Studio Enterprise (de53e040-65b5-4cee-bab9-5505db93125a)'     
          appType: 'Web App on Linux'    
          WebAppName: 'TailspinAsTest'     
          StartupCommand: 'dotnet Tailspin.SpaceGame.Web.dll' 